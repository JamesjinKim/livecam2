# 라즈베리파이 5 스마트 토글 카메라 스트리밍 서버 PRD

## 1. 프로젝트 개요

### 1.1 프로젝트 명
라즈베리파이 5 기반 스마트 토글 듀얼 카메라 스트리밍 시스템

### 1.2 목적
라즈베리파이 5의 제한된 리소스를 고려하여 **안정성을 최우선**으로 하는 스마트 토글 방식의 듀얼 카메라 스트리밍 시스템 구축

### 1.3 핵심 가치
- **안정성 우선**: 한 번에 1대 카메라만 스트리밍하여 시스템 먹통 방지
- **스마트 전환**: 안전한 리소스 정리를 통한 끊김 없는 카메라 전환
- **사용자 편의성**: 직관적인 토글 UI로 간편한 카메라 선택

### 1.4 설계 철학
> **"완벽한 동시 스트리밍보다 안정한 단일 스트리밍"**
> 
> 시스템 안정성과 장기 운영 가능성을 모든 기능보다 우선시

## 2. 목표 및 성공 지표

### 2.1 주요 목표
- 640x480 해상도, 30fps 단일 카메라 안정 스트리밍
- 3초 이내 안전한 카메라 전환
- 24시간 연속 운영 안정성 확보
- CPU 사용률 50% 이하 유지

### 2.2 성공 지표
- **안정성**: 24시간 연속 운영 성공률 > 99%
- **전환 속도**: 카메라 전환 시간 < 5초
- **리소스 효율성**: CPU 사용률 < 50%, 메모리 < 500MB
- **사용성**: 카메라 전환 성공률 > 99%

## 3. 기능 요구사항

### 3.1 핵심 기능 (스마트 토글 방식)

#### 3.1.1 스마트 카메라 전환
- **단일 스트림**: 동시에 1대 카메라만 활성화
- **안전한 전환**: 기존 카메라 완전 정리 후 새 카메라 시작
- **전환 상태 표시**: 전환 중 로딩 인디케이터 제공
- **자동 복구**: 전환 실패 시 이전 카메라로 자동 복원

#### 3.1.2 직관적 웹 UI
- **대형 단일 비디오 플레이어**: 640x480 이상 크기
- **카메라 선택 버튼**: 명확한 카메라 1/2 토글 버튼
- **상태 표시**: 현재 활성 카메라 및 전환 상태 표시
- **실시간 모니터링**: 시스템 리소스 상태 표시

#### 3.1.3 시스템 보호 기능
- **리소스 모니터링**: CPU, 메모리, 온도 실시간 감시
- **자동 보호**: 임계값 초과 시 스트림 자동 중지
- **복구 시스템**: 오류 발생 시 자동 재시작

### 3.2 부가 기능
- 카메라별 개별 설정 (품질, 프레임률)
- 자동 순환 모드 (설정 시간마다 자동 전환)
- 모바일 반응형 UI
- 스트림 녹화 (선택사항)

## 4. 비기능 요구사항

### 4.1 성능 요구사항
- **CPU 사용률**: 평상시 < 50%
- **메모리 사용량**: < 500MB
- **카메라 전환 시간**: < 5초
- **스트림 지연 시간**: < 3초

### 4.2 안정성 요구사항
- **가동률**: 99% 이상 (24시간 기준)
- **MTBF**: 7일 (168시간) 이상
- **복구 시간**: 자동 복구 < 30초

### 4.3 사용성 요구사항
- **전환 성공률**: > 99%
- **UI 응답 시간**: < 1초
- **모바일 지원**: 반응형 디자인

## 5. 기술 스택 및 아키텍처

### 5.1 스마트 토글 아키텍처
```
[카메라 1] ──┐
              ├─ [스마트 스위처] ─ [단일 FFmpeg] ─ [HLS 스트림] ─ [웹 UI]
[카메라 2] ──┘
                     │
                [리소스 모니터] ─ [자동 보호 시스템]
```

### 5.2 핵심 기술 스택
| 계층 | 기술 | 역할 | 토글 방식 최적화 |
|------|------|------|-----------------|
| OS | 라즈베리파이 OS | 기본 운영체제 | 리소스 최적화 설정 |
| 웹서버 | NGINX | 정적 파일 서빙 | 단일 스트림 최적화 |
| 백엔드 | FastAPI | 스마트 스위처 로직 | 토글 상태 관리 |
| 스트리밍 | FFmpeg + HLS | 단일 스트림 처리 | 리소스 효율 최대화 |
| 카메라 | rpicam-apps | 카메라 제어 | 안전한 시작/정지 |

### 5.3 스마트 토글 시스템 구조
```python
SmartToggleManager:
├── CameraSwitcher (카메라 전환 로직)
├── ResourceMonitor (리소스 감시)  
├── SafetyGuard (시스템 보호)
└── StateManager (상태 관리)
```

## 6. 사용자 시나리오

### 6.1 기본 사용 시나리오
1. **웹 접속**: 브라우저로 라즈베리파이 IP 접속
2. **카메라 1 시청**: 기본적으로 카메라 1 스트림 시작
3. **카메라 전환**: "카메라 2" 버튼 클릭
4. **전환 과정**: 
   - 카메라 1 안전 정지 (2-3초)
   - 카메라 2 시작 (2-3초)
   - 새 스트림 표시

### 6.2 고급 사용 시나리오
1. **자동 순환**: 설정된 시간마다 자동 카메라 전환
2. **모니터링**: 실시간 시스템 상태 확인
3. **설정 변경**: 카메라별 화질/프레임률 조정

## 7. 구현 계획

### 7.1 Phase 1: 핵심 토글 시스템 (2주)
- 스마트 카메라 스위처 구현
- 안전한 리소스 정리 로직
- 기본 웹 UI (단일 플레이어)

### 7.2 Phase 2: 사용자 경험 개선 (1주)
- 전환 상태 표시 UI
- 에러 처리 및 복구 시스템
- 모바일 반응형 디자인

### 7.3 Phase 3: 고급 기능 (1주)
- 자동 순환 모드
- 상세 모니터링 대시보드
- 설정 저장/불러오기

### 7.4 핵심 구현 로직
```bash
# 스마트 전환 프로세스
1. 현재 카메라 스트림 정지 신호 전송
2. FFmpeg 프로세스 안전 종료 대기
3. rpicam-vid 프로세스 안전 종료 대기  
4. 2-3초 리소스 정리 대기
5. 새 카메라 rpicam-vid 시작
6. 새 FFmpeg 프로세스 시작
7. HLS 스트림 준비 완료 확인
8. 웹 플레이어 자동 갱신
```

## 8. 위험 요소 및 완화 방안

### 8.1 기술적 위험 (스마트 토글 방식으로 대부분 해결)
| 위험 요소 | 기존 위험도 | 토글 방식 위험도 | 완화 방안 |
|-----------|-------------|-----------------|----------|
| CPU 과부하 | 높음 | **낮음** | 단일 스트림으로 CPU 50% 이하 |
| 메모리 부족 | 중간 | **낮음** | 최대 300MB 사용으로 제한 |
| 시스템 먹통 | 높음 | **매우 낮음** | 리소스 여유로 안정성 확보 |
| 전환 실패 | - | 중간 | 자동 복구 시스템 구현 |

### 8.2 사용성 위험
| 위험 요소 | 영향 | 완화 방안 |
|-----------|------|----------|
| 동시 시청 불가 | 중간 | 자동 순환 모드로 보완 |
| 전환 대기시간 | 낮음 | 5초 이내로 최적화 |
| 사용법 복잡성 | 낮음 | 직관적 토글 UI |

## 9. 테스트 계획

### 9.1 기능 테스트
- 카메라 전환 테스트 (1000회 연속)
- 장시간 운영 테스트 (72시간)
- 에러 상황 복구 테스트

### 9.2 성능 테스트
- 리소스 사용량 모니터링
- 전환 시간 측정
- 네트워크 부하 테스트

### 9.3 안정성 테스트
- 전원 차단/복구 테스트
- 과열 상황 시뮬레이션
- 메모리 부족 상황 테스트

## 10. 운영 및 배포

### 10.1 배포 방식
- 단일 Docker 컨테이너
- systemd 서비스 등록
- 자동 시작 스크립트

### 10.2 모니터링
- 카메라 전환 횟수 및 성공률
- 시스템 리소스 사용 패턴
- 사용자 접속 및 사용 패턴

## 11. 성공 측정 지표

### 11.1 정량적 지표
- **안정성**: 99% 가동률 달성
- **성능**: CPU 50% 이하, 메모리 500MB 이하
- **사용성**: 전환 성공률 99% 이상

### 11.2 정성적 지표
- 사용자 피드백: "안정적이다", "사용하기 쉽다"
- 운영자 만족도: "관리가 편하다", "문제가 없다"

## 12. 향후 확장 계획

### 12.1 단기 확장 (6개월)
- 개별 브라우저 접근 모드 추가
- 스트림 녹화 기능
- 알림 시스템 (이메일/슬랙)

### 12.2 장기 확장 (1년)
- 조건부 동시 스트리밍 모드
- AI 기반 자동 카메라 전환
- 클라우드 백업 기능

## 13. 결론

**스마트 토글 방식은 라즈베리파이 5의 현실적 제약을 인정하고, 사용자 경험과 시스템 안정성의 최적 균형점을 찾는 현명한 접근법입니다.**

### 핵심 장점
- ✅ **100% 안정성 보장**
- ✅ **리소스 효율 최대화**  
- ✅ **간단한 구현 및 유지보수**
- ✅ **확장 가능한 아키텍처**

### 트레이드오프
- ⚠️ 동시 다중 카메라 시청 불가
- ⚠️ 전환 시 2-5초 대기 시간

하지만 이는 **시스템 먹통 위험 제거**와 **24시간 안정 운영**이라는 훨씬 큰 가치를 위한 합리적 선택입니다.

rpicam-vid --camera 0 --width 640 --height 480 --framerate 30 -t 0 -o - --codec mjpeg --flush | \
ffmpeg -f mjpeg -i - -c:v libx264 -preset ultrafast -f flv rtmp://localhost/live/cam0

rpicam-vid --camera 1 --width 640 --height 480 --framerate 30 -t 0 -o - --codec mjpeg --flush | \
ffmpeg -f mjpeg -i - -c:v libx264 -preset ultrafast -f flv rtmp://localhost/live/cam1

rpicam-vid --camera 0 --width 640 --height 480 --framerate 30 -t 0 -o - --codec mjpeg --flush --hflip | \
ffmpeg -f mjpeg -i - -c:v libx264 -preset ultrafast -f flv rtmp://localhost/live/cam0

rpicam-vid --camera 1 --width 640 --height 480 --framerate 30 -t 0 -o - --codec mjpeg --flush --hflip | \
ffmpeg -f mjpeg -i - -c:v libx264 -preset ultrafast -f flv rtmp://localhost/live/cam1